name: Sign and Publish Helm Chart

on:
  workflow_dispatch:
  release:
    types: [published]

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Set up Helm
        uses: azure/setup-helm@v3
        with:
          version: 'v3.12.0'

      - name: Install GPG
        run: |
          sudo apt-get update
          sudo apt-get install -y gnupg

      - name: Configure Helm repo directory
        run: mkdir -p ./helm-repo

      # - name: Package and Sign Helm chart
      #   env:
      #     GPG_TTY: $(tty)
      #   run: |
      #     helm package . \
      #       --destination ./helm-repo \
      #       --sign \
      #       --key "$GPG_KEY_ID" \
      #       --keyring ~/.gnupg/secring.gpg

      - name: Extract chart version from Git tag
        id: version
        run: |
          TAG_VERSION=${GITHUB_REF#refs/tags/}
          echo "TAG_VERSION=$TAG_VERSION"
          echo "CHART_VERSION=$TAG_VERSION" >> $GITHUB_ENV

      - name: Update chart version
        run: |
          yq eval ".version = \"$CHART_VERSION\"" -i backstage-helm-chart/Chart.yaml
          echo "Chart.yaml version updated to $CHART_VERSION"
          cat backstage-helm-chart/Chart.yaml

      - name: Package Helm chart (without signing)
        run: |
          helm package backstage-helm-chart --version "$CHART_VERSION" --destination ./helm-repo
          helm repo index ./helm-repo
          ls -la ./helm-repo/

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_TOKEN }}

      - name: Push Helm Chart to Registry
        run: |
          CHART_PACKAGE=$(ls -t ./helm-repo/backstage-*.tgz | head -n 1)
          if [ -z "$CHART_PACKAGE" ]; then
            echo "Error: No Helm chart package (.tgz) found in ./helm-repo/."
            exit 1
          fi
          helm push "$CHART_PACKAGE" oci://ghcr.io/${{ github.repository_owner }}/helm-charts

      - name: Upload Helm repo as artifact
        uses: actions/upload-artifact@v4
        with:
          name: helm-chart-repo
          path: ./helm-repo
